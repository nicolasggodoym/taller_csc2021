---
title: "Taller2"
author: "Jan Dimter y Nicolás Godoy"
date: "01-09-2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

¡Hola a todas y todos! El presente documento consta de un tutorial con que se busca repasar los contenidos revisados en el curso de **Ciencias Sociales Computacionales** dictado en 2021 por el profesor _Naim Bro_, con miras a la primera evaluación del ramo, que consiste en un control de código. 

En este caso, trabajaremos con datos de la [**International Social Survey Programme (ISSP)**](http://w.issp.org/data-download/by-year/) en la quinta versión de su módulo 2019, que aborda la desigualdad social (Social Inequality V).

Lo primero para poder realizar este tutorial es cargar las librerías correspondientes. Para ello, acudiremos a la función `p_load()` de la librería `pacman`. No olviden haber **instalado esta librería** antes de iniciar el tutorial, con el comando `install.packages("pacman")`.

¡Empezamos! Carga la librería `pacman`, y luego emplea su función `p_load()` para instalar y cargar las librerías `tidyverse`, `haven`, `dplyr`, `car`, `ggplot2`, `plotly`, `sjmisc` y `sjlabelled`

```{r p_load, message=FALSE, warning=FALSE}
library(pacman)
pacman::p_load(tidyverse,
               haven,
               dplyr, 
               car,
               ggplot2,
               plotly,
               sjmisc,
               sjlabelled)
```

¡Muy bien! Ahora continuemos cargando los datos de ISSP 2019. Para ello, debes crear un objeto llamado `data` con la función `read_sav()` de la librería `haven`, para cargar el archivo issp_2019.sav ubicado en la carpeta data

```{r load_data}
data <- read_sav("data/issp_2019.sav")
```

A continuación, haremos una revisión general de los datos cargados. Ocupa la función `dim()` para obtener las dimensiones del dataframe

```{r dim}
dim(data)
```

Posteriormente, con la función `head()`, imprime las primeras 5 filas de data

```{r head}
head(data, 5)
```

Ahora imprime las columnas 10 a la 15

```{r print10_15}
data[,(10:15)]
```

Luego, emplearemos la función `filter()` de la librería `dplyr` para crear un dataframe llamado data que sólo contenga los valores para Chile (CL) en la columna `c_alphan`. Después, con el operador pipe (`%>%`), emplea la función `select()` de la librería `dplyr` para seleccionar las variables v61, TOPBOT, CL_REG, AGE, SEX y v38. A su vez, renómbralas como

- clase_sub
- ess
- region
- sexo
- edad
- conflicto, respectivamente

```{r filter_select}
data <- data %>% 
  filter(c_alphan == "CL") %>% 
  select(clase_sub = v61,
         ess = TOPBOT,
         region = CL_REG,
         edad = AGE,
         sexo = SEX,
         conflicto = v38)
```

¡Muy bien! Lo que sigue es revisar las dimensiones (`dim()`) del nuevo conjunto de datos

```{r dim2}
dim(data)
```

Con la función `head()`, imprime las 10 primeras filas del nuevo set de datos

```{r head2}
head(data, 10)
```

Ahora es momento de revisar los datatypes de cada una de las columnas. Emplea la función `str()` para revisar la estructura de los datos

```{r str}
str(data)
```

Ahora, con la función `as_factor()` de la librería `haven`, transforma todas las variables de tipo dbl+lbl a variables de tipo `factor`, a excepción de `ess` y `edad`, que debes transformar a `numeric`. Emplea la función `mutate_at()` para realizar las transformaciones de manera conjunta

```{r factor}
data <- data %>% 
  mutate_at(vars(clase_sub, region, sexo, conflicto), ~(as_factor(.))) %>% 
  mutate_at(vars(ess, edad), ~(as.numeric(.)))
```

Emplea de nuevo la función `str()` para revisar las transformaciones

```{r str2}
str(data)
```

¡Muy bien! Ahora emplea las funciones `frq()` y `descr()` de la librería `sjmisc` para explorar las variables categóricas y cuantitativas, respectivamente. 

```{r frq_descr}
frq(data$clase_sub)
frq(data$region)
frq(data$sexo)
frq(data$conflicto)

descr(data$ess)
descr(data$edad)
```

Ya estamos casi listas/os para trabajar. Lo siguiente es recodificar las variables a trabajar, antes de meter las manos en la masa. Empleemos la función `recode()` de la librería `car` para transformar en valores nulos (`NA`) aquellos valores que no aporten información relevante. Emplearemos la función `mutate()` para trabajar en conjunto y agilizar el trabajo. Las instrucciones de recodificación son las siguientes: 

- clase_sub: -9 y -1 como NA. Luego, recodificar 1 = Clase baja, 2 = Clase trabajadora, 3, 4 y 5 como Clase media, 6 como Clase alta. 
- region: -2 como NA. Luego 1 = Tarapaca, 2 = Antofagasta, 3 = Atacama, 4 = Coquimbo, 5 = Valparaiso, 6 = OHiggins, 7 = Maule, 8 = Biobio, 9 = La Araucania, 10 = Los Lagos, 11 = Aysen, 12 = Magallanes, 13 = Metropolitana, 14 = Los Rios, 15 = Arica y Parinacota, 16 = Nuble. 
- sexo: -9 como NA. Luego 1 = Hombre y 2 = Mujer. 
- conflicto: -9 y -8 como NA. Luego, 1 = Muy fuerte, 2 = Fuerte, 3 = No muy fuerte, 4 = No hay. 

Posteriormente, transformar cada una de las variables a factor con la función `as.factor`, y establecer los `levels()` en el mismo orden que las categorías. Recuerda que R es sensible a tildes, mayúsculas y espacios

```{r recode}
data <- data %>% 
  mutate(clase_sub = car::recode(.$clase_sub, recodes = c("c(-9,-1) = NA;
                                 1 = 'Clase baja'; 
                                 2 = 'Clase trabajadora'; 
                                 c(3,4,5) = 'Clase media'; 
                                 6 = 'Clase alta'"),
         as.factor = T, levels = c('Clase baja', 
                                   'Clase trabajadora',
                                   'Clase media',
                                   'Clase alta')), 
         region = car::recode(.$region, recodes = c("-2 = NA;
                              1 = 'Tarapaca';
                              2 = 'Antofagasta';
                              3 = 'Atacama';
                              4 = 'Coquimbo';
                              5 = 'Valparaiso';
                              6 = 'OHiggins';
                              7 = 'Maule';
                              8 = 'Biobio';
                              9 = 'La Araucania';
                              10 = 'Los Lagos';
                              11 = 'Aisen';
                              12 = 'Magallanes';
                              13 = 'Metropolitana';
                              14 = 'Los Rios';
                              15 = 'Arica y Parinacota';
                              16 = 'Nuble'"), 
         as.factor = T, levels = c('Tarapaca',
                              'Antofagasta',
                              'Atacama',
                              'Coquimbo',
                              'Valparaiso',
                              'OHiggins',
                              'Maule',
                              'Biobio',
                              'La Araucania',
                              'Los Lagos',
                              'Aysen',
                              'Magallanes',
                              'Metropolitana',
                              'Los Rios',
                              'Arica y Parinacota',
                              'Nuble')), 
         sexo = car::recode(.$sexo, recodes = c("-9 = NA;
                            1 = 'Hombre';
                            2 = 'Mujer'"),
         as.factor = T, levels = c('Hombre',
                                   'Mujer')),
         conflicto = car::recode(.$conflicto, recodes = c("c(-9,-8) = NA;
                                                          1 = 'Muy fuerte';
                                                          2 = 'Fuerte';
                                                          3 = 'No tan fuerte';
                                                          4 = 'No hay'"),
                                 as.factor = T, levels = c('Muy fuerte',
                                                           'Fuerte',
                                                           'No tan fuerte',
                                                           'No hay')))
```

Volvemos a emplear la función `frq()` de `sjmisc`, para revisar las recodificaciones

```{r check_recodes}
frq(data$clase_sub)
frq(data$region)
frq(data$sexo)
frq(data$conflicto)
```

Ahora, ocupamos la función `case_when()` para que crear una nueva variable llamada `macrozona`, agrupando a la variable región en Norte (Arica y Parinacota, Tarapaca, Antofagasta y Atacama); Centro (Coquimbo, Valparaiso y Metropolitana); Centro sur (OHiggins, Maule, Nuble y Biobio); Sur (La Araucania, Los Lagos y Los Rios) Austral (Aysen y Magallanes). Recuerda usar el operador or (|), y englobar todo en `mutate()`

```{r case_when}
data <- data %>% 
  mutate(macrozona = case_when(region == 'Arica y Parinacota'|region == 'Tarapaca' | region == 'Antofagasta'| region == 'Atacama' ~ 'Norte',
            region == 'Coquimbo' | region == 'Valparaiso' | region == 'Metropolitana' ~ 'Centro',
            region == 'OHiggins' | region == 'Maule' | region == 'Nuble' | region == 'Biobio' ~ 'Centro sur',
            region == 'La Araucania' | region == 'Los Lagos' | region == 'Los Rios' ~ 'Sur',
                        region == 'Aisen' | region == 'Magallanes' ~ 'Austral'))
```

¡Buen trabajo! Revisemos con `frq()`

```{r frq_case_when}
frq(data$macrozona)
```




